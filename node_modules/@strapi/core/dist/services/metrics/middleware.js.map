{"version":3,"file":"middleware.js","sources":["../../../src/services/metrics/middleware.ts"],"sourcesContent":["import type { Core } from '@strapi/types';\nimport type { Sender } from './sender';\n\ninterface State {\n  expires: number;\n  counter: number;\n}\n\nfunction nextResetDate(): number {\n  return Date.now() + 24 * 60 * 60 * 1000; // Now + 24 hours.\n}\n\nconst createMiddleware = ({ sendEvent }: { sendEvent: Sender }) => {\n  const state: State = {\n    expires: nextResetDate(),\n    counter: 0,\n  };\n\n  const middleware: Core.MiddlewareHandler = async (ctx, next) => {\n    const { url, method } = ctx.request;\n\n    if (!url.includes('.') && ['GET', 'PUT', 'POST', 'DELETE'].includes(method)) {\n      if (Date.now() > state.expires) {\n        state.expires = nextResetDate();\n        state.counter = 0;\n      }\n\n      // Send max. 1000 events per day.\n      if (state.counter < 1000) {\n        sendEvent('didReceiveRequest', { eventProperties: { url: ctx.request.url } });\n\n        // Increase counter.\n        state.counter += 1;\n      }\n    }\n\n    await next();\n  };\n\n  return middleware;\n};\n\nexport default createMiddleware;\n"],"names":[],"mappings":";AAQA,SAAS,gBAAwB;AAC/B,SAAO,KAAK,IAAQ,IAAA,KAAK,KAAK,KAAK;AACrC;AAEA,MAAM,mBAAmB,CAAC,EAAE,gBAAuC;AACjE,QAAM,QAAe;AAAA,IACnB,SAAS,cAAc;AAAA,IACvB,SAAS;AAAA,EACX;AAEM,QAAA,aAAqC,OAAO,KAAK,SAAS;AAC9D,UAAM,EAAE,KAAK,OAAO,IAAI,IAAI;AAE5B,QAAI,CAAC,IAAI,SAAS,GAAG,KAAK,CAAC,OAAO,OAAO,QAAQ,QAAQ,EAAE,SAAS,MAAM,GAAG;AAC3E,UAAI,KAAK,QAAQ,MAAM,SAAS;AAC9B,cAAM,UAAU,cAAc;AAC9B,cAAM,UAAU;AAAA,MAAA;AAId,UAAA,MAAM,UAAU,KAAM;AACd,kBAAA,qBAAqB,EAAE,iBAAiB,EAAE,KAAK,IAAI,QAAQ,IAAI,GAAG;AAG5E,cAAM,WAAW;AAAA,MAAA;AAAA,IACnB;AAGF,UAAM,KAAK;AAAA,EACb;AAEO,SAAA;AACT;;"}